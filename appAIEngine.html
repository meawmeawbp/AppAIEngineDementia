<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‡∏Ñ‡∏±‡∏î‡∏Å‡∏£‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏°‡∏≠‡∏á‡πÄ‡∏™‡∏∑‡πà‡∏≠‡∏° (‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏π‡∏î 3 ‡∏û‡∏≤‡∏£‡πå‡∏ó) ‚Äî MVP</title>
  <link rel="icon" href="data:," />
  <script defer src="https://cdn.tailwindcss.com"></script>
  <style>
    .tab-active{border-bottom:3px solid #4f46e5;color:#111827}
    .chip{padding:.25rem .6rem;border:1px solid #e5e7eb;border-radius:999px}
  </style>
</head>
<body class="bg-gray-50 text-gray-800">
<div class="max-w-4xl mx-auto p-4">
  <header class="mb-4">
    <h1 class="text-2xl font-bold">‡πÅ‡∏≠‡∏û‡∏Ñ‡∏±‡∏î‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏°‡∏≠‡∏á‡πÄ‡∏™‡∏∑‡πà‡∏≠‡∏° ‚Äî ‡πÅ‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏° + ‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á 3 ‡∏û‡∏≤‡∏£‡πå‡∏ó + ‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏ú‡∏• + ‡∏ù‡∏∂‡∏Å‡∏™‡∏°‡∏≠‡∏á</h1>
    <p class="text-sm text-gray-600">UI ‡πÅ‡∏ö‡∏ö‡πÅ‡∏ó‡πá‡∏ö ‚Ä¢ ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡∏Ñ‡πå‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÉ‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå ‚Ä¢ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å AI Engine ‡∏ú‡πà‡∏≤‡∏ô FastAPI</p>
  </header>

  <!-- Tabs -->
  <nav class="flex flex-wrap gap-4 border-b mb-4">
    <button class="py-2 px-3 tab-btn tab-active" data-target="#tab-survey">‡πÅ‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°</button>
    <button class="py-2 px-3 tab-btn" data-target="#tab-record">‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á (3 ‡∏û‡∏≤‡∏£‡πå‡∏ó)</button>
    <button class="py-2 px-3 tab-btn" data-target="#tab-result">‡∏ú‡∏•‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢</button>
    <button class="py-2 px-3 tab-btn" data-target="#tab-train">‡∏ù‡∏∂‡∏Å‡∏™‡∏°‡∏≠‡∏á</button>
  </nav>

  <!-- TAB 1: SURVEY -->
  <section id="tab-survey" class="tab-panel">
    <div class="bg-white rounded-xl shadow p-4 space-y-4">
      <div class="flex items-center gap-2">
        <span class="chip">Step 1</span>
        <h2 class="font-semibold">‡πÅ‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏° + ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h2>
      </div>

      <div class="grid gap-3 md:grid-cols-2">
        <label class="text-sm">SubjectID
          <div class="flex gap-2">
            <input id="subjectId" class="w-full border rounded-lg p-2" placeholder="‡πÄ‡∏ä‡πà‡∏ô TH250811-0001" />
            <button id="btnNewId" class="px-3 py-2 rounded-lg border bg-gray-50">‡∏™‡∏∏‡πà‡∏°</button>
          </div>
        </label>
        <label class="text-sm">‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠/‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•
          <input id="caregiver" class="w-full border rounded-lg p-2" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£" />
        </label>
        <label class="text-sm">‡∏≠‡∏≤‡∏¢‡∏∏ (‡∏õ‡∏µ)
          <input id="age" type="number" min="40" max="120" class="w-full border rounded-lg p-2" />
        </label>
        <label class="text-sm">‡πÄ‡∏û‡∏®
          <select id="gender" class="w-full border rounded-lg p-2">
            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</option><option>‡∏´‡∏ç‡∏¥‡∏á</option><option>‡∏ä‡∏≤‡∏¢</option><option>‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏</option>
          </select>
        </label>
        <label class="text-sm">‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤
          <select id="education" class="w-full border rounded-lg p-2">
            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</option><option>‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡∏õ‡∏£‡∏∞‡∏ñ‡∏°</option><option>‡∏õ‡∏£‡∏∞‡∏ñ‡∏°</option><option>‡∏°‡∏±‡∏ò‡∏¢‡∏°</option><option>‡∏≠‡∏≤‡∏ä‡∏µ‡∏ß‡∏∞/‡∏≠‡∏ô‡∏∏‡∏õ‡∏£‡∏¥‡∏ç‡∏ç‡∏≤</option><option>‡∏õ‡∏£‡∏¥‡∏ç‡∏ç‡∏≤‡∏ï‡∏£‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ</option>
          </select>
        </label>
        <label class="text-sm">‡∏†‡∏π‡∏°‡∏¥‡∏†‡∏≤‡∏Ñ/‡∏™‡∏≥‡πÄ‡∏ô‡∏µ‡∏¢‡∏á
          <select id="accent" class="w-full border rounded-lg p-2">
            <option value="">‚Äî</option><option>‡∏Å‡∏•‡∏≤‡∏á</option><option>‡∏≠‡∏µ‡∏™‡∏≤‡∏ô</option><option>‡πÄ‡∏´‡∏ô‡∏∑‡∏≠</option><option>‡πÉ‡∏ï‡πâ</option>
          </select>
        </label>
      </div>

      <label class="text-sm inline-flex items-start gap-2">
        <input id="consent" type="checkbox" class="mt-1">
        <span>‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡πá‡∏ö‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏±‡∏î‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô/‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÇ‡∏°‡πÄ‡∏î‡∏• (‡∏õ‡∏Å‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡∏ß‡∏ï‡∏ô)</span>
      </label>

      <div class="border rounded-xl p-3">
        <div class="mb-3 text-sm text-gray-600">
            ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡∏≠‡∏≤‡∏Å‡∏≤‡∏£/‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏° (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 1 ‡∏Ñ‡πà‡∏≤‡∏ï‡πà‡∏≠‡∏Ç‡πâ‡∏≠) ‚Äî ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö
        </div>
        <!-- ‡∏à‡∏±‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î 2 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ö‡∏ô‡∏à‡∏≠‡πÉ‡∏´‡∏ç‡πà / 1 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ -->
        <div id="surveyQ" class="grid gap-3 sm:grid-cols-1 md:grid-cols-2"></div>
      </div>


      <div class="flex items-center gap-3">
        <button id="btnCalc" class="bg-indigo-600 text-white px-4 py-2 rounded-xl">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
        <div id="scoreBox" class="text-sm"></div>
      </div>

      <div class="text-xs text-gray-600">
        ‡πÄ‡∏Å‡∏ì‡∏ë‡πå: 14‚Äì29 = <b>‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô</b> ‚Ä¢ 30‚Äì39 = <b>‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</b> ‚Ä¢ 40‚Äì56 = <b>‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏•‡πâ‡∏ß</b>
      </div>
    </div>
  </section>

  <!-- TAB 2: RECORD -->
  <section id="tab-record" class="tab-panel hidden">
    <div class="bg-white rounded-xl shadow p-4 space-y-4">
      <div class="flex items-center gap-2">
        <span class="chip">Step 2</span>
        <h2 class="font-semibold">‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á 3 ‡∏û‡∏≤‡∏£‡πå‡∏ó (PFT / CTD / SFT)</h2>
      </div>
      <p class="text-sm text-gray-600">‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ AI: WAV 16kHz mono (‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏õ‡∏•‡∏á‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)</p>

      <!-- PFT -->
      <div class="p-3 border rounded-xl">
        <div class="font-medium">‡∏û‡∏≤‡∏£‡πå‡∏ó 1 ‚Äî PFT (‡∏Ñ‡∏≥‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ ‚Äú‡∏Å.‚Äù) ‚Äî 60 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</div>
        <div class="flex items-center gap-2 my-2">
          <button class="btn bg-indigo-600 text-white px-3 py-1.5 rounded" data-part="PFT" data-action="start">‡πÄ‡∏£‡∏¥‡πà‡∏°</button>
          <button class="btn bg-gray-700 text-white px-3 py-1.5 rounded" data-part="PFT" data-action="stop" disabled>‡∏´‡∏¢‡∏∏‡∏î</button>
          <span id="timerPFT" class="text-sm text-gray-600">00:00</span>
        </div>
        <audio id="audioPFT" controls class="w-full hidden"></audio>
        <div id="infoPFT" class="text-xs text-gray-600"></div>
      </div>

      <!-- CTD -->
      <div class="p-3 border rounded-xl">
        <div class="font-medium">‡∏û‡∏≤‡∏£‡πå‡∏ó 2 ‚Äî CTD (‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢‡∏†‡∏≤‡∏û Cookie Theft) ‚Äî 60 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</div>
        <div class="my-2">
          <img id="ctdImg" alt="Cookie Theft" class="max-w-full rounded border" />
        </div>
        <div class="flex items-center gap-2 my-2">
          <button class="btn bg-indigo-600 text-white px-3 py-1.5 rounded" data-part="CTD" data-action="start">‡πÄ‡∏£‡∏¥‡πà‡∏°</button>
          <button class="btn bg-gray-700 text-white px-3 py-1.5 rounded" data-part="CTD" data-action="stop" disabled>‡∏´‡∏¢‡∏∏‡∏î</button>
          <span id="timerCTD" class="text-sm text-gray-600">00:00</span>
        </div>
        <audio id="audioCTD" controls class="w-full hidden"></audio>
        <div id="infoCTD" class="text-xs text-gray-600"></div>
      </div>

      <!-- SFT -->
      <div class="p-3 border rounded-xl">
        <div class="font-medium">‡∏û‡∏≤‡∏£‡πå‡∏ó 3 ‚Äî SFT (‡∏ö‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î) ‚Äî 60 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</div>
        <div class="flex items-center gap-2 my-2">
          <button class="btn bg-indigo-600 text-white px-3 py-1.5 rounded" data-part="SFT" data-action="start">‡πÄ‡∏£‡∏¥‡πà‡∏°</button>
          <button class="btn bg-gray-700 text-white px-3 py-1.5 rounded" data-part="SFT" data-action="stop" disabled>‡∏´‡∏¢‡∏∏‡∏î</button>
          <span id="timerSFT" class="text-sm text-gray-600">00:00</span>
        </div>
        <audio id="audioSFT" controls class="w-full hidden"></audio>
        <div id="infoSFT" class="text-xs text-gray-600"></div>
      </div>
    </div>
  </section>

  <!-- TAB 3: RESULT / PREDICT -->
  <section id="tab-result" class="tab-panel hidden">
    <div class="bg-white rounded-xl shadow p-4 space-y-4">
      <div class="flex items-center gap-2">
        <span class="chip">Step 3</span>
        <h2 class="font-semibold">‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏ú‡∏•‡∏à‡∏≤‡∏Å AI Engine</h2>
      </div>
      <div class="text-sm text-gray-600">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå WAV ‡∏Ç‡∏≠‡∏á 3 ‡∏û‡∏≤‡∏£‡πå‡∏ó‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</div>
      <div class="flex flex-wrap gap-3">
        <button id="btnPredict" class="bg-indigo-600 text-white px-4 py-2 rounded-xl">‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢</button>
        <span class="text-xs text-gray-500">Endpoint: <code id="predUrl"></code></span>
      </div>
      <pre id="predJson" class="text-xs bg-gray-50 p-2 rounded overflow-x-auto h-48"></pre>
      <div id="predBadge"></div>
      <div class="text-xs text-gray-500">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏ñ‡πâ‡∏≤‡∏ï‡∏¥‡∏î CORS ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô CORS ‡πÉ‡∏ô FastAPI ‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ</div>
    </div>
  </section>

  <!-- TAB 4: BRAIN TRAINING -->
  <section id="tab-train" class="tab-panel hidden">
    <div class="bg-white rounded-xl shadow p-4 space-y-4">
      <div class="flex items-center gap-2">
        <span class="chip">Step 4</span>
        <h2 class="font-semibold">‡∏ù‡∏∂‡∏Å‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏™‡∏°‡∏≠‡∏á (Mini Games)</h2>
      </div>
      <div class="grid md:grid-cols-2 gap-4">
        <div class="border rounded-xl p-3">
          <div class="font-medium mb-1">‡πÄ‡∏Å‡∏°‡∏à‡∏≥‡∏Ñ‡∏≥</div>
          <div class="text-sm text-gray-600 mb-2">‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥ 5 ‡∏Ñ‡∏≥ ‡πÉ‡∏´‡πâ‡∏à‡∏≥‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ ‡πÅ‡∏•‡πâ‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤</div>
          <div id="memWords" class="text-xl font-semibold tracking-wide"></div>
          <div class="mt-2 flex gap-2">
            <button id="btnMemShow" class="px-3 py-1.5 rounded bg-gray-700 text-white">‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥</button>
            <button id="btnMemHide" class="px-3 py-1.5 rounded bg-gray-200">‡∏ã‡πà‡∏≠‡∏ô</button>
          </div>
          <input id="memAns" class="mt-2 w-full border rounded-lg p-2" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÑ‡∏î‡πâ‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡∏£‡∏£‡∏Ñ">
          <button id="btnMemCheck" class="mt-2 px-3 py-1.5 rounded bg-indigo-600 text-white">‡∏ï‡∏£‡∏ß‡∏à</button>
          <div id="memScore" class="text-sm mt-2"></div>
        </div>

        <div class="border rounded-xl p-3">
          <div class="font-medium mb-1">‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (‡πÉ‡∏ô 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)</div>
          <div class="text-sm text-gray-600 mb-2">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á</div>
          <div class="flex items-center gap-2">
            <button id="btnAnimalStart" class="px-3 py-1.5 rounded bg-gray-700 text-white">‡πÄ‡∏£‡∏¥‡πà‡∏° 30s</button>
            <span id="animalTimer" class="text-sm text-gray-600">30</span>
          </div>
          <textarea id="animalBox" rows="4" class="mt-2 w-full border rounded-lg p-2" placeholder="‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡∏´‡∏°‡∏π ‡∏ß‡∏±‡∏ß ‡∏°‡πâ‡∏≤ ..."></textarea>
          <button id="btnAnimalScore" class="mt-2 px-3 py-1.5 rounded bg-indigo-600 text-white">‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</button>
          <div id="animalOut" class="text-sm mt-2"></div>
        </div>

        <!-- STROOP MINI -->
        <div class="border rounded-xl p-3">
            <div class="font-medium mb-1">‡∏ù‡∏∂‡∏Å‡∏™‡∏°‡∏≠‡∏á (Stroop ‡πÅ‡∏ö‡∏ö‡∏¢‡πà‡∏≠)</div>
            <div class="text-sm text-gray-600 mb-2">
                ‡πÅ‡∏ï‡∏∞‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö <b>‡∏™‡∏µ‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£</b> ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô (‡∏£‡∏≠‡∏ö‡∏•‡∏∞ 10 ‡∏Ç‡πâ‡∏≠)
            </div>

            <div id="stroopWord" class="text-3xl font-bold text-center my-4">‡πÄ‡∏£‡∏¥‡πà‡∏°</div>

            <div class="flex gap-2 justify-center mb-2">
                <button class="px-3 py-1.5 rounded bg-gray-200" data-stroop="‡πÅ‡∏î‡∏á">‡πÅ‡∏î‡∏á</button>
                <button class="px-3 py-1.5 rounded bg-gray-200" data-stroop="‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß">‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß</button>
                <button class="px-3 py-1.5 rounded bg-gray-200" data-stroop="‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô">‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô</button>
                <button class="px-3 py-1.5 rounded bg-gray-200" data-stroop="‡∏î‡∏≥">‡∏î‡∏≥</button>
            </div>

            <div class="text-center text-sm text-gray-600 mb-2">
                <span id="stroopProg">‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà 0 / 10</span>
            </div>

            <div class="flex gap-2 justify-center">
                <button id="btnStroopStart" class="px-4 py-2 rounded bg-gray-700 text-white">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏ö‡∏ö‡∏ù‡∏∂‡∏Å</button>
                <span id="stroopStatus" class="text-sm self-center"></span>
            </div>
        </div>

        <!-- REACTION TIME MINI -->
        <div class="border rounded-xl p-3">
            <div class="font-medium mb-1">‡∏ù‡∏∂‡∏Å‡∏™‡∏°‡∏≠‡∏á (Reaction Time ‡πÅ‡∏ö‡∏ö‡∏¢‡πà‡∏≠)</div>
            <div class="text-sm text-gray-600 mb-2">
                ‡∏£‡∏≠‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô <b class="text-green-600">‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß</b> ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ï‡∏∞‡πÉ‡∏´‡πâ‡πÑ‡∏ß‡∏™‡∏∏‡∏î (‡∏£‡∏≠‡∏ö‡∏•‡∏∞ 5 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)
            </div>

            <div id="rtBox" class="h-28 rounded-xl flex items-center justify-center select-none
                                    text-xl font-semibold bg-gray-200 text-gray-700">
                ‡πÅ‡∏ï‡∏∞ "‡πÄ‡∏£‡∏¥‡πà‡∏°" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏≠‡∏ö‡πÅ‡∏£‡∏Å
            </div>

            <div class="flex gap-2 justify-center mt-3">
                <button id="btnRTStart" class="px-4 py-2 rounded bg-gray-700 text-white">‡πÄ‡∏£‡∏¥‡πà‡∏°</button>
                <button id="btnRTStop"  class="px-4 py-2 rounded bg-gray-300 text-gray-700" disabled>‡∏´‡∏¢‡∏∏‡∏î/‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>

            <div class="text-center text-sm text-gray-600 mt-2">
                <span id="rtProg">‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà 0 / 5</span> ‚Ä¢ <span id="rtMsg">‡∏û‡∏£‡πâ‡∏≠‡∏°</span>
            </div>

            <div id="rtSummary" class="text-center text-sm mt-2"></div>
        </div>

      </div>
    </div>
  </section>

  <footer class="text-xs text-gray-500 mt-8">¬© 2025 MVP (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏à‡∏±‡∏¢/‡∏Ñ‡∏±‡∏î‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)</footer>
</div>

<script>
/* ====== CONFIG ====== */
const PREDICT_URL = "http://localhost:8000/predict";
const CTD_IMAGE_URL = "https://ichef.bbci.co.uk/news/1024/cpsprodpb/13E17/production/_114913418_cookietheft.jpg.webp";
/* ==================== */

/* ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á Apps Script Web App (‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢ /exec) */
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwcx8wyuIBqgBem0rygTBtuBmxqMifZOjuACaVOINAY9hRTEGrkYiFdrMfYEeoYgfA/exec";
/* ==================== */


/* Tabs */
const tabs = document.querySelectorAll('.tab-btn');
const panels = document.querySelectorAll('.tab-panel');
tabs.forEach(btn => {
  btn.addEventListener('click', () => {
    tabs.forEach(b => b.classList.remove('tab-active'));
    panels.forEach(p => p.classList.add('hidden'));
    btn.classList.add('tab-active');
    document.querySelector(btn.dataset.target).classList.remove('hidden');
  });
});

/* Subject ID */
function newSubjectId(){
  const d = new Date();
  const pad = n=>String(n).padStart(2,'0');
  const y = String(d.getFullYear()).slice(-2), m=pad(d.getMonth()+1), dd=pad(d.getDate()), hh=pad(d.getHours()), mm=pad(d.getMinutes());
  return `TH${y}${m}${dd}-${hh}${mm}`;
}
document.getElementById('btnNewId').onclick = ()=>{
  document.getElementById('subjectId').value = newSubjectId();
};
document.getElementById('predUrl').textContent = PREDICT_URL;

/* Survey builder */
const CHOICES = [
  {text:"‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô", score:4},
  {text:"‡πÄ‡∏Å‡∏∑‡∏≠‡∏ö‡∏ó‡∏∏‡∏Å‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå", score:3},
  {text:"‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏•‡∏∞ 1‚Äì2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á", score:2},
  {text:"‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢ ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏µ‡∏•‡∏∞‡∏Ñ‡∏£‡∏±‡πâ‡∏á", score:1},
];
const QUESTIONS = [
  "‡∏•‡∏∑‡∏°‡∏Ç‡∏≠‡∏á/‡∏•‡∏∑‡∏°‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏ö‡πà‡∏≠‡∏¢",
  "‡∏´‡∏•‡∏á‡∏ó‡∏≤‡∏á‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡πâ‡∏ô‡πÄ‡∏Ñ‡∏¢",
  "‡πÄ‡∏•‡πà‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏ã‡πâ‡∏≥ ‡πÜ",
  "‡∏´‡∏≤‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏á‡πà‡∏≤‡∏¢ ‡πÜ ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠",
  "‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô/‡∏à‡πà‡∏≤‡∏¢‡∏ö‡∏¥‡∏•‡∏¢‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô",
  "‡∏™‡∏°‡∏≤‡∏ò‡∏¥‡∏•‡∏î‡∏•‡∏á ‡∏ó‡∏≥‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏¢‡∏≤‡∏Å",
  "‡∏™‡∏±‡∏ö‡∏™‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤/‡∏§‡∏î‡∏π‡∏Å‡∏≤‡∏•",
  "‡∏ï‡∏≤‡∏°‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á/‡∏ï‡∏≤‡∏°‡∏Ç‡πà‡∏≤‡∏ß‡πÑ‡∏°‡πà‡∏ó‡∏±‡∏ô",
  "‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ö‡πâ‡∏≤‡∏ô/‡∏á‡∏≤‡∏ô‡∏≠‡∏î‡∏¥‡πÄ‡∏£‡∏Å‡∏¢‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô",
  "‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå/‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ä‡∏±‡∏î",
  "‡∏ô‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏ö‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏•‡∏≤",
  "‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡∏´‡∏á‡∏∏‡∏î‡∏´‡∏á‡∏¥‡∏î‡∏á‡πà‡∏≤‡∏¢",
  "‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏Ç‡∏±‡∏î (‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á)",
  "‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡∏ä‡πâ‡∏≤‡∏•‡∏á/‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ö‡πà‡∏≠‡∏¢"
];
function buildSurvey(){
  const box = document.getElementById('surveyQ');
  box.innerHTML = "";
  QUESTIONS.forEach((q, qi) => {
    const name = `q${qi}`;

    // ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°
    const card = document.createElement('div');
    card.className = "p-3 border rounded-xl h-full flex flex-col gap-2";

    // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°
    const qText = document.createElement('div');
    qText.className = "text-sm font-medium";
    qText.textContent = `${qi+1}. ${q}`;
    card.appendChild(qText);

    // ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (2x2)
    const opts = document.createElement('div');
    opts.className = "grid grid-cols-2 gap-2";

    CHOICES.forEach(c => {
      const id = `${name}-${c.score}`;
      const label = document.createElement('label');
      // ‡πÉ‡∏ä‡πâ peer-checked ‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
      label.className = "cursor-pointer";

      label.innerHTML = `
        <input id="${id}" type="radio" name="${name}" value="${c.score}"
               class="peer sr-only">
        <div class="w-full text-sm rounded-lg border px-3 py-2
                    hover:bg-gray-50
                    peer-checked:bg-indigo-600 peer-checked:text-white peer-checked:border-indigo-600
                    transition-colors">
          ${c.text}
        </div>
      `;
      opts.appendChild(label);
    });

    card.appendChild(opts);
    box.appendChild(card);
  });
}
buildSurvey();

function calcScore(){
  let total = 0, answered=0;
  for(let i=0;i<QUESTIONS.length;i++){
    const sel = document.querySelector(`input[name="q${i}"]:checked`);
    if(sel){ total += Number(sel.value); answered++; }
  }
  const label = (total>=14 && total<=29) ? "‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô"
               : (total>=30 && total<=39) ? "‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á"
               : (total>=40 && total<=56) ? "‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏•‡πâ‡∏ß" : "‚Äî";
  document.getElementById('scoreBox').innerHTML =
    `<div class="p-2 rounded bg-gray-50 border">
      ‡∏ï‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß: ${answered}/${QUESTIONS.length} ‚Ä¢ ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°: <b>${total}</b> ‚Ä¢ Label: <b>${label}</b>
    </div>`;
  return {total, label};
}
document.getElementById('btnCalc').onclick = calcScore;

/* Recording (3 parts) -> record as webm, then convert to WAV16k before sending */
const rec = {
  PFT:{chunks:[], blob:null, seconds:0, media:null, timer:null, wav:null},
  CTD:{chunks:[], blob:null, seconds:0, media:null, timer:null, wav:null},
  SFT:{chunks:[], blob:null, seconds:0, media:null, timer:null, wav:null},
};
function fmt(sec){const m=String(Math.floor(sec/60)).padStart(2,'0');const s=String(sec%60).padStart(2,'0');return m+":"+s;}
function attachPart(part){
  const btnStart = document.querySelector(`.btn[data-part="${part}"][data-action="start"]`);
  const btnStop  = document.querySelector(`.btn[data-part="${part}"][data-action="stop"]`);
  const timerEl  = document.getElementById('timer'+part);
  const audioEl  = document.getElementById('audio'+part);
  const infoEl   = document.getElementById('info'+part);

  // formatter ‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á mm:ss
  const fmtMMSS = (sec) => {
    const m = String(Math.floor(sec/60)).padStart(2,'0');
    const s = String(sec%60).padStart(2,'0');
    return `${m}:${s}`;
  };

  // ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏¢‡∏∏‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏≠‡∏±‡∏î (‡∏Å‡∏±‡∏ô‡∏Ñ‡∏•‡∏¥‡∏Å)
  btnStop.onclick = () => {};

  btnStart.onclick = async () => {
    if(!document.getElementById('consent').checked){
      alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡πä‡∏Å‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡∏Å‡πà‡∏≠‡∏ô'); return;
    }

    // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏î‡∏¥‡∏°
    if (rec[part].timer){ clearInterval(rec[part].timer); rec[part].timer = null; }
    rec[part].chunks = []; rec[part].blob = null; rec[part].wav = null;
    rec[part].seconds = 0;
    let remaining = 60;                      // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà 60 ‡∏ß‡∏¥
    timerEl.textContent = fmtMMSS(remaining);

    // ‡∏Ç‡∏≠‡πÑ‡∏°‡∏Ñ‡πå
    let stream;
    try{
      stream = await navigator.mediaDevices.getUserMedia({ audio:true });
    }catch(e){
      alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô‡πÑ‡∏î‡πâ'); return;
    }

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á MediaRecorder
    const mr = new MediaRecorder(stream, { mimeType:'audio/webm' });
    rec[part].media = mr;

    mr.ondataavailable = e => { if(e.data && e.data.size>0) rec[part].chunks.push(e.data); };

    mr.onstop = async () => {
      // ‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡∏ß‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ + ‡∏õ‡∏¥‡∏î‡πÑ‡∏°‡∏Ñ‡πå
      if (rec[part].timer){ clearInterval(rec[part].timer); rec[part].timer = null; }
      stream.getTracks().forEach(t=>t.stop());

      // ‡∏£‡∏ß‡∏°‡πÑ‡∏ü‡∏•‡πå + ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• ‡πÅ‡∏•‡∏∞‡πÅ‡∏õ‡∏•‡∏á WAV16k
      rec[part].blob = new Blob(rec[part].chunks, {type:'audio/webm'});
      audioEl.src = URL.createObjectURL(rec[part].blob);
      audioEl.classList.remove('hidden');
      infoEl.textContent = `‡πÑ‡∏ü‡∏•‡πå ~ ${(rec[part].blob.size/1024).toFixed(1)} KB, ‡∏¢‡∏≤‡∏ß ~ ${fmtMMSS(rec[part].seconds) } (‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô WAV16k...)`;
      
      try{
        rec[part].wav = await webmToWav16k(rec[part].blob);
        infoEl.textContent = `‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ AI: ${(rec[part].wav.size/1024).toFixed(1)} KB (WAV 16kHz mono)`;

      // üîΩ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡∏∂‡πâ‡∏ô Google Drive ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
      uploadToDrive(part, rec[part].wav, rec[part].seconds, infoEl);
      
      }catch(err){
        infoEl.textContent = '‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message;
      }

      // ‡∏Ñ‡∏∑‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏∏‡πà‡∏°
      btnStart.disabled = false;
      btnStop.disabled  = true;
    };

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏î
    mr.start(100);

    // ‡∏•‡πá‡∏≠‡∏Å‡∏õ‡∏∏‡πà‡∏°: ‡πÄ‡∏£‡∏¥‡πà‡∏° = ‡∏õ‡∏¥‡∏î, ‡∏´‡∏¢‡∏∏‡∏î = ‡∏õ‡∏¥‡∏î (‡∏Å‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)
    btnStart.disabled = true;
    btnStop.disabled  = true;      // ‡∏õ‡∏¥‡∏î‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏≠‡∏á

    // ‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á 60 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏¢‡∏∏‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
    rec[part].timer = setInterval(()=>{
      remaining--;
      rec[part].seconds++;                 // ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏î‡∏à‡∏£‡∏¥‡∏á (‡∏ô‡∏±‡∏ö‡∏Ç‡∏∂‡πâ‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡∏∏‡∏õ)
      timerEl.textContent = fmtMMSS(remaining);

      if (remaining <= 0){
        clearInterval(rec[part].timer); rec[part].timer = null;
        if (mr.state !== 'inactive') mr.stop();   // onstop ‡∏à‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö
      }
    }, 1000);
  };
}


['PFT','CTD','SFT'].forEach(attachPart);
document.getElementById('ctdImg').src = CTD_IMAGE_URL;

/* WebAudio helpers: decode and re-encode to WAV 16k mono */
async function webmToWav16k(blob){
  const arrBuf = await blob.arrayBuffer();
  const online = new (window.AudioContext||window.webkitAudioContext)();
  const decoded = await online.decodeAudioData(arrBuf);
  const ch0 = decoded.getChannelData(0);
  const srcSR = decoded.sampleRate;
  online.close();

  const dstSR = 16000;
  const offline = new (window.OfflineAudioContext||window.webkitOfflineAudioContext)(1, Math.ceil(ch0.length*dstSR/srcSR), dstSR);
  const buf = offline.createBuffer(1, ch0.length, srcSR);
  buf.copyToChannel(ch0,0);
  const src = offline.createBufferSource(); src.buffer = buf; src.connect(offline.destination); src.start();
  const rendered = await offline.startRendering();
  const pcm = rendered.getChannelData(0);
  const pcm16 = floatTo16BitPCM(pcm);
  return encodeWAV(pcm16, dstSR);
}
function floatTo16BitPCM(float32){ const out=new Int16Array(float32.length); for(let i=0;i<float32.length;i++){ let s=Math.max(-1,Math.min(1,float32[i])); out[i]= s<0? s*0x8000 : s*0x7FFF; } return out; }
function encodeWAV(int16, sampleRate=16000){
  const byteRate=sampleRate*2, blockAlign=2;
  const buf=new ArrayBuffer(44+int16.length*2), v=new DataView(buf);
  const w=(o,s)=>{ for(let i=0;i<s.length;i++) v.setUint8(o+i, s.charCodeAt(i)); };
  w(0,"RIFF"); v.setUint32(4,36+int16.length*2,true); w(8,"WAVE"); w(12,"fmt ");
  v.setUint32(16,16,true); v.setUint16(20,1,true); v.setUint16(22,1,true);
  v.setUint32(24,sampleRate,true); v.setUint32(28,byteRate,true);
  v.setUint16(32,blockAlign,true); v.setUint16(34,16,true);
  w(36,"data"); v.setUint32(40,int16.length*2,true);
  for(let i=0,off=44;i<int16.length;i++,off+=2) v.setInt16(off,int16[i],true);
  return new Blob([v],{type:"audio/wav"});
}

// --- ‡πÅ‡∏õ‡∏•‡∏á Blob ‚Üí dataURL(base64)
function blobToBase64(blob){
  return new Promise((resolve,reject)=>{
    const fr = new FileReader();
    fr.onload = () => resolve(fr.result);
    fr.onerror = reject;
    fr.readAsDataURL(blob);
  });
}

// --- ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏õ Google Drive ‡∏ú‡πà‡∏≤‡∏ô Apps Script
async function uploadToDrive(part, wavBlob, seconds, infoEl){
  try{
    if(!WEBAPP_URL) throw new Error("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ WEBAPP_URL");
    const subjectId = document.getElementById('subjectId').value || 'Unknown';
    const gender    = (document.getElementById('gender')||{}).value || '';
    const education = (document.getElementById('education')||{}).value || '';
    const accent    = (document.getElementById('accent')||{}).value || '';

    // ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå
    const now = new Date(), pad = n=>String(n).padStart(2,'0');
    const dt  = `${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}`;
    const filename = `${subjectId}_${part}_${dt}.wav`;

    // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô base64 (data URL)
    const dataUrl = await blobToBase64(wavBlob);

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á metadata ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á‡πÑ‡∏õ Apps Script
    const meta = {
      Filename: filename,
      SubjectID: subjectId,
      Task: part,
      Gender: gender,
      Education: education,
      RegionAccent: accent,
      DurationSec: seconds,
      AvgRMS: null,          // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ QC ‡∏Å‡πá‡∏™‡πà‡∏á null ‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡πÑ‡∏î‡πâ
      SilenceRatio: null,
      ClipCount: null,
      Recorder: navigator.userAgent,
      DateTimeISO: new Date().toISOString(),
      AudioBase64: dataUrl   // ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
    };

    // ‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö simple request (‡πÑ‡∏°‡πà‡∏°‡∏µ preflight) ‡∏î‡πâ‡∏ß‡∏¢ text/plain
    let resp = await fetch(WEBAPP_URL, {
      method: "POST",
      headers: { "Content-Type":"text/plain;charset=utf-8" },
      body: JSON.stringify(meta)
    });

    // ‡∏ñ‡πâ‡∏≤‡πÇ‡∏î‡∏ô CORS ‡∏Å‡πá fallback ‡πÄ‡∏õ‡πá‡∏ô no-cors (‡∏™‡πà‡∏á‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡∏≠‡πà‡∏≤‡∏ô‡∏ú‡∏•‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)
    if(!resp.ok){
      await fetch(WEBAPP_URL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type":"text/plain;charset=utf-8" },
        body: JSON.stringify(meta)
      });
      if(infoEl) infoEl.innerHTML += " ‚Ä¢ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î (no-cors) ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ";
      return;
    }

    // ‡∏≠‡πà‡∏≤‡∏ô‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö (‡∏ñ‡πâ‡∏≤‡∏ú‡πà‡∏≤‡∏ô CORS)
    const js = await resp.json().catch(()=>({}));
    if(js && js.ok){
      if(infoEl){
        const link = js.url ? ` <a href="${js.url}" target="_blank" rel="noopener">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô Drive</a>` : "";
        infoEl.innerHTML += ` ‚Ä¢ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ${link}`;
      }
    }else{
      if(infoEl) infoEl.innerHTML += " ‚Ä¢ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à (‡∏≠‡πà‡∏≤‡∏ô‡∏ú‡∏•‡πÑ‡∏°‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå) ‚úÖ";
    }
  }catch(err){
    if(infoEl) infoEl.innerHTML += ` ‚Ä¢ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${err.message}`;
  }
}


/* Predict via FastAPI */
document.getElementById('btnPredict').onclick = async ()=>{
  const outEl = document.getElementById('predJson');
  const badge = document.getElementById('predBadge');
  badge.innerHTML = ""; outEl.textContent = "";

  const pft = rec.PFT.wav, ctd = rec.CTD.wav, sft = rec.SFT.wav;
  if(!pft || !ctd || !sft){ outEl.textContent = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏î‡∏Ñ‡∏£‡∏ö‡∏ó‡∏±‡πâ‡∏á 3 ‡∏û‡∏≤‡∏£‡πå‡∏ó‡∏Å‡πà‡∏≠‡∏ô"; return; }

  try{
    const fd = new FormData();
    fd.append('pft', new File([pft], 'pft.wav', {type:'audio/wav'}));
    fd.append('ctd', new File([ctd], 'ctd.wav', {type:'audio/wav'}));
    fd.append('sft', new File([sft], 'sft.wav', {type:'audio/wav'}));
    outEl.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå...";
    const res = await fetch(PREDICT_URL, { method:'POST', body: fd });
    const js  = await res.json();
    outEl.textContent = JSON.stringify(js, null, 2);

    // ‡πÅ‡∏™‡∏î‡∏á badge ‡∏™‡∏£‡∏∏‡∏õ
    const decision = (js.decision||"").toLowerCase();
    let color = "bg-gray-200 text-gray-800", text = "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ú‡∏•";
    if(decision.includes("normal")||decision.includes("‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô")){ color="bg-green-100 text-green-800"; text="‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô (normal)"; }
    if(decision.includes("risk")||decision.includes("‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á")){ color="bg-yellow-100 text-yellow-800"; text="‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á"; }
    if(decision.includes("dementia")||decision.includes("‡πÄ‡∏õ‡πá‡∏ô")){ color="bg-red-100 text-red-800"; text="‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏•‡πâ‡∏ß"; }
    badge.innerHTML = `<div class="inline-block px-3 py-1 rounded ${color}">‡∏ú‡∏•‡∏™‡∏£‡∏∏‡∏õ: <b>${text}</b></div>`;
  }catch(err){
    outEl.textContent = "‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message;
  }
};

/* Brain training */
const WORD_BANK = ["‡∏î‡∏≠‡∏Å‡πÑ‡∏°‡πâ","‡∏ä‡πâ‡∏≠‡∏ô","‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠","‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤","‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå","‡πÄ‡∏Å‡πâ‡∏≤‡∏≠‡∏µ‡πâ","‡∏´‡∏°‡∏ß‡∏Å","‡∏™‡∏∞‡∏û‡∏≤‡∏ô","‡∏†‡∏π‡πÄ‡∏Ç‡∏≤","‡πÅ‡∏°‡πà‡∏ô‡πâ‡∏≥"];
function randWords(n=5){ const a=[...WORD_BANK].sort(()=>Math.random()-0.5).slice(0,n); return a; }
let curWords = randWords();
document.getElementById('memWords').textContent = curWords.join(" ‚Ä¢ ");
document.getElementById('btnMemShow').onclick = ()=>{ document.getElementById('memWords').textContent = curWords.join(" ‚Ä¢ "); };
document.getElementById('btnMemHide').onclick = ()=>{ document.getElementById('memWords').textContent = "‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"; };
document.getElementById('btnMemCheck').onclick = ()=>{
  const ans = document.getElementById('memAns').value.trim().split(/\s+/).filter(Boolean);
  const set = new Set(curWords);
  let ok=0; ans.forEach(x=>{ if(set.has(x)) ok++; });
  document.getElementById('memScore').textContent = `‡∏à‡∏≥‡πÑ‡∏î‡πâ ${ok}/${curWords.length} ‡∏Ñ‡∏≥`;
  curWords = randWords(); // ‡∏ä‡∏∏‡∏î‡πÉ‡∏´‡∏°‡πà‡∏£‡∏≠‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
};

let animalTimer=null, left=30;
document.getElementById('btnAnimalStart').onclick = ()=>{
  left = 30; document.getElementById('animalTimer').textContent = left;
  if(animalTimer) clearInterval(animalTimer);
  animalTimer = setInterval(()=>{ left--; document.getElementById('animalTimer').textContent = left; if(left<=0){ clearInterval(animalTimer); } },1000);
};
document.getElementById('btnAnimalScore').onclick = ()=>{
  const txt = document.getElementById('animalBox').value.trim();
  const items = txt.split(/[\s,;]+/).filter(Boolean);
  const uniq = Array.from(new Set(items));
  document.getElementById('animalOut').textContent = `‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${items.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‚Ä¢ ‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥ ${uniq.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
};

/* ====== Stroop mini game ====== */
const STROOP_COLORS = [
  {name:"‡πÅ‡∏î‡∏á",   css:"#ef4444"},
  {name:"‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß", css:"#22c55e"},
  {name:"‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô", css:"#3b82f6"},
  {name:"‡∏î‡∏≥",    css:"#111827"},
];

let stroopRound = 0, stroopOK = 0, stroopStartTime = 0, stroopSpent = 0;
let stroopAnswer = null;

const $sw   = id => document.getElementById(id);
const elWord = $sw('stroopWord');
const elProg = $sw('stroopProg');
const elStat = $sw('stroopStatus');
const BTN_STROOP = Array.from(document.querySelectorAll('[data-stroop]'));

function stroopNext(){
  if (stroopRound >= 10){
    const sec = (stroopSpent/1000).toFixed(1);
    elStat.innerHTML = `‡∏à‡∏ö! ‡∏ñ‡∏π‡∏Å ${stroopOK}/10 ‚Ä¢ ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤ ${sec}s`;
    elWord.style.color = ""; elWord.textContent = "‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß";
    BTN_STROOP.forEach(b=> b.disabled = true);
    return;
  }
  // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏Ñ‡∏≥" ‡∏Å‡∏±‡∏ö "‡∏™‡∏µ" ‡πÅ‡∏ö‡∏ö‡∏™‡∏∏‡πà‡∏° (‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô)
  const word = STROOP_COLORS[Math.floor(Math.random()*STROOP_COLORS.length)];
  const col  = STROOP_COLORS[Math.floor(Math.random()*STROOP_COLORS.length)];
  elWord.textContent = word.name;
  elWord.style.color = col.css;
  stroopAnswer = col.name;          // ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏∑‡∏≠ "‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏µ" ‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£
  stroopRound++;
  elProg.textContent = `‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà ${stroopRound} / 10`;
}

function stroopReset(){
  stroopRound = 0; stroopOK = 0; stroopSpent = 0;
  stroopAnswer = null; elStat.textContent = "";
  BTN_STROOP.forEach(b=> b.disabled = false);
  stroopStartTime = performance.now();
  stroopNext();
}

$sw('btnStroopStart').addEventListener('click', stroopReset);

BTN_STROOP.forEach(btn=>{
  btn.addEventListener('click', ()=>{
    if (!stroopAnswer) return;
    if (btn.dataset.stroop === stroopAnswer) stroopOK++;
    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏ö
    if (stroopRound === 10){
      stroopSpent = performance.now() - stroopStartTime;
    }
    stroopNext();
  });
});
/* ===== end Stroop ===== */
/* ===== Reaction Time Mini (5 trials) ===== */
const rtBox = document.getElementById('rtBox');
const rtStart = document.getElementById('btnRTStart');
const rtStop  = document.getElementById('btnRTStop');
const rtProg  = document.getElementById('rtProg');
const rtMsg   = document.getElementById('rtMsg');
const rtSum   = document.getElementById('rtSummary');

let rtTrial = 0, rtTimes = [], rtTimer = null, rtReadyAt = 0, rtClickable = false;

function fmtMs(ms){ return Math.round(ms) + ' ms'; }
function randDelay(min=800, max=2500){ return Math.floor(Math.random()*(max-min+1))+min; }

function rtReset(){
  clearTimeout(rtTimer); rtTimer = null;
  rtTrial = 0; rtTimes = []; rtClickable = false; rtReadyAt = 0;
  rtBox.style.backgroundColor = '#e5e7eb'; // gray-200
  rtBox.style.color = '#374151';
  rtBox.textContent = '‡πÅ‡∏ï‡∏∞ "‡πÄ‡∏£‡∏¥‡πà‡∏°" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏≠‡∏ö‡πÅ‡∏£‡∏Å';
  rtProg.textContent = '‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà 0 / 5';
  rtMsg.textContent = '‡∏û‡∏£‡πâ‡∏≠‡∏°';
  rtSum.textContent = '';
  rtStart.disabled = false; rtStop.disabled = true;
}

function rtNext(){
  if (rtTrial >= 5){
    // ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•
    const n = rtTimes.length || 1;
    const mean = rtTimes.reduce((a,b)=>a+b,0)/n;
    const sd   = Math.sqrt(rtTimes.map(t => (t-mean)**2).reduce((a,b)=>a+b,0)/n);
    rtSum.innerHTML = `‡∏™‡∏£‡∏∏‡∏õ: ‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ <b>${fmtMs(mean)}</b> ‚Ä¢ ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏ö‡∏µ‡πà‡∏¢‡∏á‡πÄ‡∏ö‡∏ô‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô ${fmtMs(sd)}`;
    rtStart.disabled = false; rtStop.disabled = true;
    rtMsg.textContent = '‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß';
    return;
  }
  rtTrial++;
  rtProg.textContent = `‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà ${rtTrial} / 5`;
  rtMsg.textContent = '‡∏£‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ... ‡∏´‡πâ‡∏≤‡∏°‡∏Å‡∏î';

  // ‡∏£‡∏∞‡∏¢‡∏∞‡∏£‡∏≠‡πÅ‡∏ö‡∏ö‡∏™‡∏∏‡πà‡∏°‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
  const wait = randDelay();
  rtClickable = false;
  rtBox.style.backgroundColor = '#e5e7eb';
  rtBox.style.color = '#374151';
  rtBox.textContent = '‡∏£‡∏≠...';

  rtTimer = setTimeout(()=>{
    rtBox.style.backgroundColor = '#059669'; // green-600
    rtBox.style.color = 'white';
    rtBox.textContent = '‡πÅ‡∏ï‡∏∞‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ!';
    rtClickable = true;
    rtReadyAt = performance.now();
  }, wait);
}

rtBox.addEventListener('click', ()=>{
  if (!rtStart.disabled) return; // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°
  // ‡∏Å‡∏î‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ = ‡πÇ‡∏Å‡∏á/‡∏û‡∏•‡∏≤‡∏î
  if (!rtClickable){
    rtMsg.textContent = '‡∏Å‡∏î‡πÄ‡∏£‡πá‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ! ‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ‡∏ô‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà';
    // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ (‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏¥‡πà‡∏° rtTrial)
    clearTimeout(rtTimer); rtTimer = null;
    setTimeout(rtNext, 700);
    return;
  }
  const now = performance.now();
  const rt = now - rtReadyAt;
  rtTimes.push(rt);
  rtMsg.textContent = `‡πÑ‡∏î‡πâ ${fmtMs(rt)} üëç`;
  rtClickable = false;
  setTimeout(rtNext, 700);
});

rtStart.addEventListener('click', ()=>{
  rtStart.disabled = true; rtStop.disabled = false;
  rtNext();
});
rtStop.addEventListener('click', rtReset);

// initial
rtReset();


/* Init */
document.getElementById('subjectId').value = newSubjectId();
</script>
</body>
</html>
